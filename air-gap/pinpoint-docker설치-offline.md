# Pinpoint Docker

Java로 작성된 대규모 분산 시스템을위한 APM (Application Performance Management) 도구

## Server 설치: docker-compose

### prerequire

centos7 기준

#### 설치파일 준비

먼저 외부망에 접속되는 환경에서 관련 파일을 다운로드 한 다음 pinpoint 서버에 전송하고 설치한다.

- docker.tar.gz (docker-ce, docker-cli 등)
- docker-compose
- pinpoint-docker.tar.gz
- pinpoint-agent-1.8.5.tar.gz
- java, maven <= 내부 yum packge repository에 없을 경우 사전에 설치파일 준비

##### docker.tar.gz

```
sudo su
yum install -y epel-release.noarch
yum-config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
yum-config-manager --enable docker-ce-nightly
yum makecache fast
mkdir ~/docker
cd ~/docker
yumdownloader --resolve docker-ce-19.03 libseccomp container-selinux
tar cvzf ~/docker.tar.gz *
```

#####docker-compose

```
curl -L "https://github.com/docker/compose/releases/download/1.25.0/docker-compose-$(uname -s)-$(uname -m)" -o ~/docker-compose
```

##### pinpoint-docker.tar.gz

부산은행의 경우 public docker repository가 열려 있기 때문에 은행 내부에 들어가서 이미지를 준비한다. (사이즈가 크기 때문)

```
git clone https://github.com/naver/pinpoint-docker.git
cd pinpoint-docker
docker-compose pull && docker-compose up -d

docker save -o pinpoint-docker-1.8.5-images.tar $(docker images | grep -e pinpointdocker -e zookeeper -e flink | awk '{print $1":"$2}')

#docker save -o pinpoint-docker-1.8.5-images.tar \
#  $(docker images | awk '{if ($1 != "REPOSITORY" \
#      && $1 ~ /pinpointdocker|flink/) print $1":"$2}' \
#    && docker images zookeeper:3.4 | awk '{if ($1 != "REPOSITORY") print $1":"$2}' \
#  )

cd ..
tar -czvf pinpoint-docker.tar.gz pinpoint-docker/
```

##### pinpoint-agent-1.8.5.tar.gz

```
curl -OL https://github.com/naver/pinpoint/releases/download/1.8.5/pinpoint-agent-1.8.5.tar.gz
```



#### docker 설치

```
mkdir -p /app/docker/rpms
mv docker.tar.gz /app/docker
cd /app/docker
tar xvf docker.tar.gz -C ./rpms
cd rpms
sudo rpm -ivh --replacefiles --replacepkgs *.rpm

sudo systemctl enable docker.service
sudo systemctl start docker.service

sudo groupadd docker
sudo gpasswd -a ${USER} docker
sudo systemctl restart docker.service
exit
```

#### docker compose 설치

```
sudo mv ~/docker-compose /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
```

#### docker mtu 설정

ip link로 eth0의 mtu값을 확인하고 이에 맞게 변경한다. 맞춰주지 않으면 docker conatiner에서 외부로 네트워크 연결이 안되기 때문에 반드시 맞춰 주도록 한다.

```
ip link show eth0 | grep mtu
```

변경

```
$ sudo vi /etc/docker/daemon.json
{
    "mtu": 1450
}

$ sudo systemctl restart docker
```

> https://docs.docker.com/v17.09/engine/userguide/networking/default_network/custom-docker0/



### 구성요소

- pinpoint-hbase: collector 및 web에서 스토리지 백엔드로 사용
- pinpoint-mysql (optional): 알람기능 사용 시 사용자, 이메일, SMS 등 정보 저장
- pinpoint-web: 대시보드 화면
- pinpoint-collector: 데이터 수집 서버
- pinpoint-quickstart (optional): 샘플 응용 프로그램
- pinpoint-agent
- zookeepers (optional)
- flink (optional): 어플리케이션 Inspector. 리소스 데이터에 대한 집계화면



### Port
- collector
  - tcp: 9994, 9995, 9996
  - udp: 9995, 9996
- web: 8079
- quickstart: 8000
- flink: 8081
- mysql: 13306



### 설치

위에서 먼저 저장 및 업로드한 파일을 pinpoint서버 접속하여 설치한다.

```
tar -xzvf pinpoint-docker.tar.gz -C /app/pinpoint-docker
cd /app/pinpoint-docker
```

#### 이미지 로드

```
$ vi pinpoint-docker-images.txt

pinpointdocker/pinpoint-quickstart:latest
pinpointdocker/pinpoint-agent:1.8.5
pinpointdocker/pinpoint-collector:1.8.5
pinpointdocker/pinpoint-web:1.8.5
pinpointdocker/pinpoint-mysql:1.8.5
pinpointdocker/pinpoint-hbase:1.8.5
zookeeper:3.4
flink:1.3.1
```

```
$ vi pinpoint-docker-load-images.sh

#!/bin/bash
list="pinpoint-docker-images.txt"
images="pinpoint-docker-1.8.5-images.tar"

POSITIONAL=()
while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        -r|--registry)
        reg="$2"
        shift # past argument
        shift # past value
        ;;
        -l|--image-list)
        list="$2"
        shift # past argument
        shift # past value
        ;;
        -i|--images)
        images="$2"
        shift # past argument
        shift # past value
        ;;
        -h|--help)
        help="true"
        shift
        ;;
    esac
done

usage () {
    echo "USAGE: $0 [--image-list pinpoint-docker-images.txt] [--images pinpoint-docker-1.8.5-images.tar] --registry my.registry.com:5000"
    echo "  [-l|--images-list path] text file with list of images. 1 per line."
    echo "  [-l|--images path] tar.gz generated by docker save."
    echo "  [-r|--registry registry:port] target private registry:port."
    echo "  [-h|--help] Usage message"
}

if [[ -z $reg ]]; then
    usage
    exit 1
fi
if [[ $help ]]; then
    usage
    exit 0
fi

set -e -x

docker load --input ${images}

for i in $(cat ${list}); do
    case $i in
    */*)
        docker tag ${i} ${reg}/${i}
        docker push ${reg}/${i}
        ;;
    *)
        docker tag ${i} ${reg}/pinpointdocker/${i}
        docker push ${reg}/pinpointdocker/${i}
        ;;
    esac
done
```

```
chmod +x pinpoint-docker-load-images.sh
./pinpoint-docker-load-images.sh --image-list ./pinpoint-docker-images.txt --registry registry.pcld.busanbank.co.kr:5000

find ./ -name "docker-compose.yml" -exec sed -i 's/pinpointdocker/registry.pcld.busanbank.co.kr\:5000\/pinpointdocker/g' {} \;
find ./ -name "docker-compose.yml" -exec sed -i 's/image\: zookeeper/image\: registry.pcld.busanbank.co.kr\:5000\/pinpointdocker\/zookeeper/g' {} \;
find ./ -name "docker-compose.yml" -exec sed -i 's/image\: flink/image\: registry.pcld.busanbank.co.kr\:5000\/pinpointdocker\/flink/g' {} \;

docker-compose up -d
```

> https://github.com/naver/pinpoint-docker



### haproxy

```
listen pinpoint-flink
    balance  roundrobin
    bind :8081
    log global
    mode tcp
    option tcplog
    server  httpw1 10.0.0.110:8081 check

listen pinpoint-web
    balance  roundrobin
    bind :8079
    log global
    mode tcp
    option tcplog
    server  httpw1 10.0.0.110:8079 check

listen pinpoint-collector
    balance  roundrobin
    bind :9994-9996
    log global
    mode tcp
    option tcplog
    server  httpw1 10.0.0.110 check
```



## Agent 설치

pinpoint-agent는 두 가지 방식으로 설치하여 사용한다.

- Docker 컨테이너
- App에 Agent파일 Include

### Docker 컨테이너

모니터링 대상 어플리케이션이 Kubernetes나 PaaS 등에 배포되지 않고 Standalone 형태로 (Docker 포함) 실행될 경우에 적합한 형태

App이 실행되는 서버에 docker 컨테이너로 실행하고, App에서 agent 컨테이너를 바라 보도록 설정한다.

agent 이미지는 사전에 준비한 pinpoint-docker.tar.gz 파일안에 포함되어 있다. pinpoint-docker/docker-compose.yml에서 agent 제외한 모듈 모두 제거하고, COLLECTOR_IP에 pinpoint-collector IP 입력하고 docker-compose up -d 한다.

```
$ vi pinpoint-docker/docker-compose.yml

version: "3.6"
services:
  pinpoint-agent:
    build:
      context: ./pinpoint-agent/
      dockerfile: Dockerfile
      args:
        - PINPOINT_VERSION=${PINPOINT_VERSION}
    container_name: "${PINPOINT_AGENT_NAME}"
    image: "pinpointdocker/pinpoint-agent:${PINPOINT_VERSION}"
    restart: unless-stopped
    networks:
      - pinpoint
    volumes:
      - data-volume:/pinpoint-agent
    environment:
      - COLLECTOR_IP=10.0.0.110
      - COLLECTOR_TCP_PORT=${COLLECTOR_TCP_PORT}
      - COLLECTOR_STAT_PORT=${COLLECTOR_STAT_PORT}
      - COLLECTOR_SPAN_PORT=${COLLECTOR_SPAN_PORT}
      - PROFILER_SAMPLING_RATE=${PROFILER_SAMPLING_RATE}
      - DEBUG_LEVEL=${AGENT_DEBUG_LEVEL}
volumes:
  data-volume:
  mysql_data:
networks:
  pinpoint:
    driver: bridge
```

#### App 실행

docker container로 실행된 agent와 동일한 vm에서 app을 실행하여 agent를 바라보도록 하여 app 모니터링 정보를 수집하도록 한다.

```
$ vi .env

PINPOINT_VERSION=1.8.5
APP_PORT=8000
AGENT_ID=app-in-docker
APP_NAME=quickapp
```

```
$ vi docker-compose.yml

version: "2.1"
services:
  tomcat:
    #build if needed
#    build:
#      context: .
#      dockerfile: Dockerfile
    container_name: "tomcat"
    image: tomcat:8.0
    ports:
      - "${APP_PORT:-8080}:8080"
    volumes_from:
      - container:pinpoint-agent
    environment:
      JAVA_OPTS: "-javaagent:/pinpoint-agent/pinpoint-bootstrap-${PINPOINT_VERSION}.jar -Dpinpoint.agentId=${AGENT_ID} -Dpinpoint.applicationName=${APP_NAME}"
    command: catalina.sh run
networks:
  default:
    external:
      name: pinpoint-docker_pinpoint
```



### App에 Agent파일 Include

현재 Pinpoint 버전 1.8.5에서는 사이드카 방식의 배포를 지원하지 않기 때문에 모니터링 대상 어플리케이션이 Kubernetes에 배포될 경우엔 어플리케이션 빌드 시 agent를 삽입해야 한다.

> https://github.com/naver/pinpoint-docker/issues/34

#### prerequire

App을 빌드하는 서버에 jdk가 설치되어 있어야 한다. 또한 예제에서 maven 빌드를 하기 때문에 maven도 설치한다.

```
sudo yum install -y java-1.8.0-openjdk-devel.x86_64
sudo yum install -y maven
```

#### agent 설치파일 압축해제

아래 예제는 kubernetes에 배포되는 sample-app인 front-k8s로 작성. 사전에 준비된 pinpoint-agent-1.8.5.tar.gz 파일 압축해제

```
export APP_PATH=/home/centos/workspace/spring/front-k8s
export AGENT_PATH=$APP_PATH/pinpoint-agent

cd $APP_PATH
mkdir pinpoint-agent
tar -xzvf pinpoint-agent-1.8.5.tar.gz -C pinpoint-agent
```

#### agent 설정

```
$ vi $AGENT_PATH/pinpoint.config

profiler.collector.ip=10.0.0.110
```

#### Dockerfile 수정

- AGENT_ID: Unique한 값으로 설정
- APPLICATION_NAME: 앱 이름으로써 동일한 이름을 사용 시 하나의 그룹으로 묶인다

```
FROM openjdk:8-jre-alpine

ENV AGENT_VERSION 1.8.5
ENV JAR_FILE front-k8s-0.0.1-SNAPSHOT.jar
ENV GW_HOME /usr/front

COPY pinpoint-agent $GW_HOME/pinpoint-agent

ENV AGENT_PATH $GW_HOME/pinpoint-agent
ENV AGENT_ID front-msa-1
ENV APPLICATION_NAME msa
ENV JAVA_OPTS "$JAVA_OPTS -javaagent:$AGENT_PATH/pinpoint-bootstrap-$AGENT_VERSION.jar"
ENV JAVA_OPTS "$JAVA_OPTS -Dpinpoint.agentId=$AGENT_ID"
ENV JAVA_OPTS "$JAVA_OPTS -Dpinpoint.applicationName=$APPLICATION_NAME"

EXPOSE 8080
COPY target/$JAR_FILE $GW_HOME/
WORKDIR $GW_HOME
ENTRYPOINT ["sh", "-c"]
VOLUME ["$AGENT_PATH"]

CMD ["exec java -jar $JAVA_OPTS $JAR_FILE"]
```

#### App 빌드 및 배포

```
mvn -DskipTests=true clean package

docker login -u admin -p password https://도커레지스트리주소
docker build -t 도커프로젝트/front-k8s .
docker push 도커프로젝트/front-k8s

kubectl create secret docker-registry regcred --docker-server=registry.pcld.busanbank.co.kr:5000 --docker-username=admin --docker-password=Zmffkdnem1! --docker-email=sudouser@crossent.com

kubectl apply -f front-deployment-k8s.yml
```

> https://lemontia.tistory.com/806
>
> https://yamoe.tistory.com/544



## 운영

### 등록된 App 삭제

- PASSWORD: 서버 설치 시 실행된 pinpoint-web 컨테이너 안에 /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/pinpoint-web.properties 파일에서 admin.password 값을 확인한다.

  ```
  docker exec -it pinpoint-web cat /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/pinpoint-web.properties | grep admin.password
  ```

삭제실행

pinpoint-web에서 제공하는 admin api를 호출

```
http://$PINPOINT_WEB:8079/admin/removeApplicationName.pinpoint?applicationName=$APPLICATION_NAME&password=$PASSWORD
```

> https://naver.github.io/pinpoint/faq.html

